name: Build

# This workflow will work for pushes, pull requests, or a manual trigger (workflow_dispatch).
on: [push, pull_request, workflow_dispatch]

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build:
    name: "${{ matrix.platform.name }} (CF_RUNTIME_SHADER_COMPILATION=${{ matrix.runtime_shader_compilation.value }})"
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 20

    defaults:
      run:
        shell: bash

    strategy:
      # Don't cancel other in-progress jobs if one fails.
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-2025-vs2026]
        compiler: [gcc, clang, msvc]
        runtime_shader_compilation: [ON, OFF]
        exclude:
          # msvc is only available on Windows
          - os: ubuntu-latest
            compiler: msvc
          - os: macos-latest
            compiler: msvc
          # gcc on Windows would require MinGW â€” excluded for simplicity
          - os: windows-latest
            compiler: gcc
          # TODO - Add iOS and Android platforms. Waiting on better support from GitHub.

    steps:
      # Linux needs to install various dependencies.
      - name: Install Linux Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends build-essential git make \
          pkg-config gnome-desktop-testing \
          libaudio-dev libfribidi-dev \
          libxkbcommon-dev libgl1-mesa-dev libgles2-mesa-dev \
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev libthai-dev \
          liburing-dev
        if: matrix.platform.name == 'Linux'

      - uses: actions/checkout@master

      # Move to new version of CMake for later language support for C23.
      - name: Install CMake and Ninja
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 4.2.3
          ninjaVersion: latest

      - name: Setup CCache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.runtime_shader_compilation }}

      - name: Set up MSVC developer environment
        if: matrix.compiler == 'msvc'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set compiler environment
        shell: bash
        run: |
          case "${{ matrix.compiler }}" in
            gcc)
              echo "CC=gcc" >> "$GITHUB_ENV"
              echo "CXX=g++" >> "$GITHUB_ENV"
              ;;
            clang)
              echo "CC=clang" >> "$GITHUB_ENV"
              echo "CXX=clang++" >> "$GITHUB_ENV"
              ;;
            msvc)
              echo "CC=cl" >> "$GITHUB_ENV"
              echo "CXX=cl" >> "$GITHUB_ENV"
              ;;
          esac

      - name: Create build folder with CMake
        run: |
          cmake ${{ matrix.platform.generate }} ${{ matrix.runtime_shader_compilation.cmake_arg }} \
            -B build_folder

      - name: Configure
        shell: bash
        run: >
          cmake -B build -G Ninja
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          -DCF_RUNTIME_SHADER_COMPILATION=${{ matrix.shader_compilation }}

      - name: Build
        run: cmake --build build --parallel

      - name: Print ccache stats
        run: ccache --show-stats

      - name: Test
        shell: bash
        run: |
          ./build/tests

      - name: Generate artifacts for Windows
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          robocopy include dist *.h
          if %errorlevel% geq 8 exit /b 1
          robocopy build\lib dist cute*.lib
          if %errorlevel% geq 8 exit /b 1
          robocopy build\lib dist libcute*.a
          if %errorlevel% geq 8 exit /b 1
          7z a artifact.zip .\dist\*

      - name: Generate artifacts for macOS
        if: runner.os == 'macOS'
        run: |
          mkdir -p ./dist
          cp -v ./include/*.h ./dist
          cp -R -v ./build/lib/libcute*.a ./dist
          tar -czvf artifact.tar.gz -C dist .

      - name: Generate artifacts for Linux
        if: runner.os == 'Linux'
        run: |
          mkdir -p ./dist
          cp -v ./include/*.h ./dist
          cp -v ./build/lib/libcute*.a ./dist
          tar -czvf artifact.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.compiler }}-shader-${{ matrix.shader_compilation }}
          path: |
            artifact.zip
            artifact.tar.gz
          if-no-files-found: error

      # Upload docsparser binary for documentation job (Linux only, one matrix combination)
      - name: Upload docsparser artifact
        uses: actions/upload-artifact@v4
        with:
          name: docsparser
          path: ./build_folder/docsparser
          if-no-files-found: error
        if: runner.os == 'Linux' && matrix.runtime_shader_compilation == 'ON'

  docs:
    name: Build documentation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download docsparser artifact
        uses: actions/download-artifact@v4
        with:
          name: docsparser
          path: ./build/debug

      - name: Make docsparser executable and run
        run: |
          chmod +x ./build/debug/docsparser
          cd build/debug
          ./docsparser

      - name: Set up Python runtime
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libcairo2-dev libfreetype6-dev libffi-dev libjpeg-dev libpng-dev libz-dev pngquant
          pip install mkdocs mkdocs-material "mkdocs-material[imaging]" markdown-callouts

      - name: Build documentation
        run: |
          mkdocs build --clean
          mkdocs --version

      - name: Adjust permissions
        run: |
          chmod -c -R +rX site/ | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-docs:
    name: Deploy documentation
    needs: docs
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
