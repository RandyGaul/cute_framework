name: Build

# This workflow will work for pushes, pull requests, or a manual trigger (workflow_dispatch).
on: [push, pull_request, workflow_dispatch]

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build:
    name: "${{ matrix.platform.name }} (CF_RUNTIME_SHADER_COMPILATION=${{ matrix.runtime_shader_compilation.value }})"
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 20

    defaults:
      run:
        shell: bash

    strategy:
      # Don't cancel other in-progress jobs if one fails.
      fail-fast: false
      matrix:
        runtime_shader_compilation:
          - { value: "ON", cmake_arg: "-DCF_RUNTIME_SHADER_COMPILATION=ON" }
          - { value: "OFF", cmake_arg: "-DCF_RUNTIME_SHADER_COMPILATION=OFF" }
        platform:
          - {
              name: "Windows",
              os: windows-2025--vs2026,
              artifact: "mscv17",
              generate: '-G "Ninja" -DSDL_RENDER=OFF -DSDL_CCACHE=ON',
            }
          - {
              name: "macOS",
              os: macos-latest,
              artifact: "macos",
              generate: '-G "Ninja" -DSDL_RENDER=OFF -DSDL_CCACHE=ON',
            }
          - {
              name: "Linux",
              os: ubuntu-latest,
              artifact: "linux",
              generate: '-G "Ninja" -DSDL_JACK=OFF -DSDL_PIPEWIRE=OFF -DSDL_PULSEAUDIO=OFF -DSDL_SNDIO=OFF -DSDL_ALSA=OFF -DSDL_WAYLAND=OFF -DSDL_X11=OFF -DSDL_KMSDRM=OFF -DSDL_RENDER=OFF -DSDL_CCACHE=ON -DSDL_OPENGL=OFF -DSDL_OPENGLES=OFF -DSDL_UNIX_CONSOLE_BUILD=ON',
            }
          # TODO - Add iOS and Android platforms. Waiting on better support from GitHub.

    steps:
      - uses: actions/checkout@master

      # Move to new version of CMake for later language support for C23.
      - name: Setup CMake 4.2.x
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 4.2.3
          ninjaVersion: latest

      # Linux needs to install various dependencies.
      - name: Install Linux Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends build-essential git make \
          pkg-config gnome-desktop-testing \
          libaudio-dev libfribidi-dev \
          libxkbcommon-dev libgl1-mesa-dev libgles2-mesa-dev \
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev libthai-dev \
          liburing-dev
        if: matrix.platform.name == 'Linux'

      # - name: Install ccache (macOS)
      #   run: brew install ccache
      #   if: runner.os == 'macOS'
      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache --zero-stats
        # if: runner.os != 'Windows'

      - name: Restore ccache (Linux)
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-master-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-
        if: runner.os == 'Linux'

      - name: Restore ccache (macOS)
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-master-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-
        if: runner.os == 'macOS'

      - name: Restore ccache (Windows)
        uses: actions/cache@v4
        with:
          path: C:\ccache
          key: ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-${{ github.ref_name }}-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-master-
            ccache-${{ matrix.platform.artifact }}-${{ matrix.runtime_shader_compilation.value }}-
        if: runner.os == 'Windows'

      - name: Create build folder with CMake
        run: |
          cmake ${{ matrix.platform.generate }} ${{ matrix.runtime_shader_compilation.cmake_arg }} \
            -B build_folder

      - name: Build project binary
        run: |
          cmake --build build_folder

      - name: Run Tests (Windows)
        shell: cmd
        run: |
          cd build_folder
          tests.exe
          cd ..\..
        if: runner.os == 'Windows'

      - name: Run Tests (macOS)
        run: |
          cd build_folder
          ./tests
          cd ..
        if: runner.os == 'macOS'

      - name: Run Tests (Linux)
        run: |
          cd build_folder
          ./tests
          cd ..
        if: runner.os == 'Linux'

      - name: Print ccache stats
        run: ccache --show-stats
        if: runner.os != 'Windows'

      - name: Generate artifacts for Windows
        shell: cmd
        run: |
          robocopy include dist *.h
          robocopy build_folder\lib dist cute*.lib
          robocopy build_folder\lib dist libcute*.a
          7z a ${{ matrix.platform.artifact }}.zip .\dist\*
        if: runner.os == 'Windows'

      - name: Generate artifacts for MacOS
        run: |
          mkdir -p ./dist
          cp -v ./include/*.h ./dist
          cp -R -v ./build_folder/lib/libcute*.a ./dist
          tar -czvf ${{ matrix.platform.artifact }}.tar.gz -C dist .
        if: runner.os == 'macOS'

      - name: Generate artifacts for Linux
        run: |
          mkdir -p ./dist
          cp -v ./include/*.h ./dist
          cp -v ./build_folder/lib/libcute*.a ./dist
          tar -czvf ${{ matrix.platform.artifact }}.tar.gz -C dist .
        if: runner.os == 'Linux'

      # Uploads the zip archives onto the workflow. They can be downloaded for 90 days (by default).
      # Find them here: https://github.com/RandyGaul/cute_framework/actions
      - uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: ${{ matrix.platform.artifact }}
          path: ./dist/
        if: matrix.runtime_shader_compilation.value == 'ON'

      # Upload docsparser binary for documentation job (Linux only, one matrix combination)
      - name: Upload docsparser artifact
        uses: actions/upload-artifact@v4
        with:
          name: docsparser
          path: ./build_folder/docsparser
          if-no-files-found: error
        if: runner.os == 'Linux' && matrix.runtime_shader_compilation.value == 'ON'

  docs:
    name: Build documentation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download docsparser artifact
        uses: actions/download-artifact@v4
        with:
          name: docsparser
          path: ./build/debug

      - name: Make docsparser executable and run
        run: |
          chmod +x ./build/debug/docsparser
          cd build/debug
          ./docsparser

      - name: Set up Python runtime
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libcairo2-dev libfreetype6-dev libffi-dev libjpeg-dev libpng-dev libz-dev pngquant
          pip install mkdocs mkdocs-material "mkdocs-material[imaging]" markdown-callouts

      - name: Build documentation
        run: |
          mkdocs build --clean
          mkdocs --version

      - name: Adjust permissions
        run: |
          chmod -c -R +rX site/ | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-docs:
    name: Deploy documentation
    needs: docs
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
